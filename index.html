<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reading Bankbook (Local)</title>

    <style>
        :root {
            --accent: #d100c9;
            /* magenta */
            --accent-weak: rgba(209, 0, 201, .12);
            --accent-mid: rgba(209, 0, 201, .22);
            --ink: #111;
        }

        body {
            margin: 0;
            padding: 24px 16px 28px;
            padding-top: max(24px, env(safe-area-inset-top));
            padding-bottom: max(28px, env(safe-area-inset-bottom));
        }

        .wrap {
            width: 100%;
            max-width: 920px;
            margin: 0 auto;

            padding-left: max(0px, env(safe-area-inset-left));
            padding-right: max(0px, env(safe-area-inset-right));
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 16px;
            /* 14 â†’ 16 */
        }

        .row {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(5, 1fr);
        }

        .row>label {
            display: grid;
            gap: 6px;
            font-size: 13px;
        }

        input,
        button {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        /* Subtle magenta focus (inputs) */
        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-weak);
        }

        button {
            cursor: pointer;
        }

        button,
        .star {
            -webkit-tap-highlight-color: rgba(209, 0, 201, 0.18);
        }

        /* Primary button (Add) only */
        button.primary {
            border-color: var(--accent);
            background: var(--accent);
            color: #fff;
            font-weight: 700;
        }

        button.primary:hover {
            filter: brightness(0.97);
        }

        button.primary:active {
            transform: translateY(1px);
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        }

        .bankbook {
            background: #fff;
        }

        /* Bankbook lines (Date / Title / Amount / Actions) */
        .line {
            display: grid;
            grid-template-columns: 90px 1fr 120px 100px;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
        }

        .line.header {
            font-weight: 700;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }

        .small {
            color: #666;
            font-size: 12px;
        }

        .pager {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .totals {
            display: grid;
            gap: 6px;
            padding-top: 10px;
        }

        .totals .trow {
            display: flex;
            justify-content: space-between;
        }

        /* BALANCE banner */
        .balance-banner {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 14px;
            border: 2px solid var(--accent);
            border-radius: 14px;
            background: linear-gradient(0deg, var(--accent-weak), #fafafa);
            box-shadow: 0 6px 18px rgba(209, 0, 201, .10);
        }

        .balance-banner .label {
            color: var(--accent);
        }


        .balance-banner .value {
            font-size: 28px;
            font-weight: 900;
        }

        /* Rating stars */
        .stars {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 42px;
        }

        .star {
            border: none;
            background: transparent;
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 20px;
            line-height: 1;
            color: #111;
            /* off = black */
            position: relative;
            overflow: hidden;
            transition: transform 120ms ease, background 120ms ease;
        }

        .star:hover {
            background: var(--accent-weak);
        }

        .star.is-on {
            color: #f5c400;
            /* yellow star */
            background: transparent;
        }

        .star.is-on {
            color: #f5c400;
            /* on = yellow */
            border-color: #111;
            background: #fafafa;
            transform: scale(1.05);
        }

        .star:active {
            transform: scale(0.96);
        }

        /* Sparkle sweep */
        .star.sparkle::after {
            content: "";
            position: absolute;
            top: -30%;
            left: -60%;
            Â© width: 60%;
            height: 160%;
            transform: rotate(25deg);
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.9) 40%,
                    rgba(209, 0, 201, 0.35) 55%,
                    rgba(255, 255, 255, 0.9) 70%,
                    rgba(255, 255, 255, 0) 100%);
            animation: sparkle-sweep 450ms ease-out;
            pointer-events: none;
        }

        @keyframes sparkle-sweep {
            from {
                left: -70%;
            }

            to {
                left: 130%;
            }
        }

        /* Responsive */
        @media (max-width: 860px) {
            .line {
                grid-template-columns: 90px 1fr 100px;
            }

            /*
            .line .hide-sm {
                display: none;
            }
            */
        }

        @media (max-width: 600px) {
            .row {
                grid-template-columns: 1fr;
            }

            .pager {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .balance-banner {
                justify-content: center;
            }

            .stars {
                justify-content: flex-start;
            }

            .bankbook .actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h2 style="margin:0 0 6px 0;">Reading Bankbook (Local)</h2>
            <div class="small">USD only â€¢ 20 lines per page â€¢ Saved in this browser</div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 10px 0;">Add an entry</h3>
            <form id="form">
                <div class="row">
                    <label>Date
                        <input id="date" type="date" required />
                    </label>

                    <label>Title
                        <input id="title" type="text" placeholder="e.g., Charlotte's Web" required maxlength="120" />
                    </label>

                    <label>Author (optional)
                        <input id="author" type="text" placeholder="e.g., E. B. White" maxlength="80" />
                    </label>

                    <label>Price (USD)
                        <input id="price" type="text" inputmode="decimal" placeholder="e.g., 12.99" />
                        <div class="small">How much is this book worth?</div>
                    </label>

                    <label>Rating
                        <div class="stars" id="rating" role="radiogroup" aria-label="Rating (1 to 3 stars)">
                            <button type="button" class="star" data-value="1" aria-label="1 star">â˜…</button>
                            <button type="button" class="star" data-value="2" aria-label="2 stars">â˜…</button>
                            <button type="button" class="star" data-value="3" aria-label="3 stars">â˜…</button>
                            <input type="hidden" id="ratingValue" value="0" />
                        </div>
                        <div class="small">Tap a star (optional)</div>
                    </label>
                </div>

                <div class="actions" style="margin-top:12px;">
                    <button type="submit" class="primary">Add</button>
                </div>
            </form>
        </div>

        <div class="card bankbook">
            <div class="actions" style="justify-content: space-between;">
                <div>
                    <h3 style="margin:0 0 4px 0;">Bankbook</h3>
                    <div class="small">Tip: Add entries to grow the balance ðŸ’°</div>
                </div>
                <div class="actions">
                    <button id="exportBtn" type="button">Export JSON</button>
                    <button id="importBtn" type="button">Import JSON</button>
                    <button id="resetBtn" type="button">Reset</button>
                </div>
            </div>

            <div class="pager" style="margin:12px 0 8px 0;">
                <button id="prevBtn" type="button">â—€ Prev</button>
                <div class="mono">Page <span id="pageNum">1</span> / <span id="pageMax">1</span></div>
                <button id="nextBtn" type="button">Next â–¶</button>
                <div class="balance-banner mono">
                    <div class="label">BALANCE</div>
                    <div class="value" id="balanceTop">$0.00</div>
                </div>
            </div>

            <div class="mono">
                <div class="line header">
                    <div>Date</div>
                    <div>Title</div>
                    <div>Amount</div>
                    <div class="hide-sm">Actions</div>
                </div>
                <div id="lines"></div>

                <div class="totals mono">
                    <div class="trow"><span>PAGE TOTAL</span><span id="pageTotal">$0.00</span></div>
                    <div class="trow" style="font-weight:900; font-size:18px;">
                        <span>BALANCE</span>
                        <span id="balanceBottom">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input id="filePick" type="file" accept="application/json" style="display:none;" />

    <script>
        // ---- Storage ----
        const KEY = "reading_bankbook_v1_usd";
        const PAGE_SIZE = 20;

        /** @returns {Array} */
        function loadEntries() {
            try {
                const raw = localStorage.getItem(KEY);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch { return []; }
        }
        function saveEntries(entries) {
            localStorage.setItem(KEY, JSON.stringify(entries));
        }

        // ---- Money helpers (USD cents as integer) ----
        function parseUsdToCents(str) {
            const s = (str || "").trim();
            if (!s) return 0;
            const cleaned = s.replace(/\$/g, "").replace(/,/g, "");
            if (!/^\d+(\.\d{0,2})?$/.test(cleaned)) return null;
            const [dollars, centsRaw = ""] = cleaned.split(".");
            const cents = (centsRaw + "00").slice(0, 2);
            const n = Number(dollars) * 100 + Number(cents);
            return Number.isFinite(n) ? n : null;
        }
        function formatCents(cents) {
            const sign = cents < 0 ? "-" : "";
            const abs = Math.abs(cents);
            const dollars = Math.floor(abs / 100);
            const rem = String(abs % 100).padStart(2, "0");
            return `${sign}$${dollars}.${rem}`;
        }

        // ---- Ordering: date ASC then created_at ASC ----
        function sortEntries(entries) {
            return [...entries].sort((a, b) => {
                const da = a.date || "";
                const db = b.date || "";
                if (da < db) return -1;
                if (da > db) return 1;
                return (a.created_at || 0) - (b.created_at || 0);
            });
        }

        // ---- UI State ----
        let entries = sortEntries(loadEntries());
        let page = 1;

        // ---- Elements ----
        const form = document.getElementById("form");
        const dateEl = document.getElementById("date");
        const titleEl = document.getElementById("title");
        const authorEl = document.getElementById("author");
        const priceEl = document.getElementById("price");

        const ratingWrapEl = document.getElementById("rating");
        const ratingValueEl = document.getElementById("ratingValue");

        const linesEl = document.getElementById("lines");
        const pageNumEl = document.getElementById("pageNum");
        const pageMaxEl = document.getElementById("pageMax");
        const pageTotalEl = document.getElementById("pageTotal");
        const balanceTopEl = document.getElementById("balanceTop");
        const balanceBottomEl = document.getElementById("balanceBottom");

        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const resetBtn = document.getElementById("resetBtn");
        const exportBtn = document.getElementById("exportBtn");
        const importBtn = document.getElementById("importBtn");
        const filePick = document.getElementById("filePick");

        // ---- Init default date ----
        dateEl.valueAsDate = new Date();

        // ---- Rating logic ----
        function setRating(val) {
            ratingValueEl.value = String(val);
            const v = Number(val);
            ratingWrapEl.querySelectorAll(".star").forEach(btn => {
                const n = Number(btn.dataset.value);
                btn.classList.toggle("is-on", n <= v);
                btn.setAttribute("aria-checked", n === v ? "true" : "false");
            });
        }

        ratingWrapEl.querySelectorAll(".star").forEach(btn => {
            btn.addEventListener("click", () => {
                const clicked = Number(btn.dataset.value);
                const current = Number(ratingValueEl.value || "0");
                const next = (clicked === current ? 0 : clicked);

                setRating(next);

                // sparkle on ON stars
                ratingWrapEl.querySelectorAll(".star").forEach(s => {
                    const n = Number(s.dataset.value);
                    s.classList.remove("sparkle");
                    if (n <= next && next > 0) {
                        void s.offsetWidth; // restart animation
                        s.classList.add("sparkle");
                    }
                });

                window.clearTimeout(ratingWrapEl._sparkleTimer);
                ratingWrapEl._sparkleTimer = window.setTimeout(() => {
                    ratingWrapEl.querySelectorAll(".star").forEach(s => s.classList.remove("sparkle"));
                }, 500);
            });
        });

        setRating(0);

        // ---- Add entry ----
        form.addEventListener("submit", (e) => {
            e.preventDefault();

            const date = dateEl.value;
            const title = titleEl.value.trim();
            const author = authorEl.value.trim();
            const rating = Math.max(0, Math.min(3, Number(ratingValueEl.value || 0)));

            if (!date || !title) return;

            const cents = parseUsdToCents(priceEl.value);
            if (cents === null) {
                alert("Price format is invalid. Use like 12.99");
                return;
            }
            const amount_cents = cents;

            const entry = {
                id: crypto.randomUUID(),
                child_id: "child-1",
                title,
                author: author || "",
                type: "read",
                date, // YYYY-MM-DD
                cover_url: "",
                amount_cents,
                currency: "USD",
                rating,
                created_at: Date.now()
            };

            entries = sortEntries([...entries, entry]);
            saveEntries(entries);

            page = Math.max(1, Math.ceil(entries.length / PAGE_SIZE));

            form.reset();
            setRating(0);
            dateEl.valueAsDate = new Date();
            render();
        });

        // ---- Delete entry ----
        function deleteEntry(id) {
            entries = entries.filter(e => e.id !== id);
            saveEntries(entries);
            const maxPage = Math.max(1, Math.ceil(entries.length / PAGE_SIZE));
            page = Math.min(page, maxPage);
            render();
        }

        // ---- Render ----
        function render() {
            const maxPage = Math.max(1, Math.ceil(entries.length / PAGE_SIZE));
            page = Math.min(Math.max(1, page), maxPage);

            pageNumEl.textContent = String(page);
            pageMaxEl.textContent = String(maxPage);

            const start = (page - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageEntries = entries.slice(start, end);

            // Totals
            const balance = entries.reduce((sum, e) => sum + (e.amount_cents || 0), 0);
            const pageTotal = pageEntries.reduce((sum, e) => sum + (e.amount_cents || 0), 0);

            balanceTopEl.textContent = formatCents(balance);
            balanceBottomEl.textContent = formatCents(balance);
            pageTotalEl.textContent = formatCents(pageTotal);

            // Lines
            linesEl.innerHTML = "";
            if (pageEntries.length === 0) {
                const div = document.createElement("div");
                div.className = "small";
                div.style.padding = "10px 0";
                div.textContent = "No entries yet. Add a Read entry to start your savings!";
                linesEl.appendChild(div);
            } else {
                pageEntries.forEach((e) => {
                    const row = document.createElement("div");
                    row.className = "line";

                    const mmdd = (() => {
                        const [y, m, d] = (e.date || "").split("-");
                        return (m && d) ? `${m}/${d}` : e.date;
                    })();

                    const amount = formatCents(e.amount_cents || 0);
                    const stars = "â˜…".repeat(Math.max(0, Math.min(3, Number(e.rating || 0))));

                    row.innerHTML = `
            <div>${mmdd}</div>
            <div title="${escapeHtml(e.title)}">
              ${escapeHtml(e.title)} ${stars ? `<span class="small"> ${stars}</span>` : ""}
            </div>
            <div style="text-align:right;">${amount}</div>
            <div class="hide-sm" style="text-align:right;">
              <button type="button" data-del="${e.id}">Delete</button>
            </div>
          `;

                    row.querySelector("button")?.addEventListener("click", () => deleteEntry(e.id));
                    linesEl.appendChild(row);
                });
            }

            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= maxPage;
        }

        // helper to avoid accidental undefined issues
        function sayMax(n) { return n; }

        function escapeHtml(s) {
            return (s || "").replace(/[&<>"']/g, (c) => ({
                "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
            }[c]));
        }

        // ---- Paging ----
        prevBtn.addEventListener("click", () => { page--; render(); });
        nextBtn.addEventListener("click", () => { page++; render(); });

        // ---- Export / Import / Reset ----
        exportBtn.addEventListener("click", () => {
            const payload = { version: 2, currency: "USD", page_size: PAGE_SIZE, entries };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "reading-bankbook.json";
            a.click();
            URL.revokeObjectURL(url);
        });

        importBtn.addEventListener("click", () => filePick.click());
        filePick.addEventListener("change", async () => {
            const file = filePick.files?.[0];
            if (!file) return;
            try {
                const text = await file.text();
                const obj = JSON.parse(text);
                const imported = Array.isArray(obj.entries) ? obj.entries : [];

                const cleaned = imported
                    .filter(e => e && typeof e.title === "string" && typeof e.date === "string")
                    .map(e => ({
                        id: e.id || crypto.randomUUID(),
                        child_id: e.child_id || "child-1",
                        title: String(e.title).slice(0, 120),
                        author: String(e.author || "").slice(0, 80),
                        type: "read",
                        date: String(e.date).slice(0, 10),
                        cover_url: String(e.cover_url || ""),
                        amount_cents: Number.isFinite(e.amount_cents) ? Math.max(0, Math.round(e.amount_cents)) : 0,
                        currency: "USD",
                        rating: Math.max(0, Math.min(3, Number(e.rating || 0))),
                        created_at: Number.isFinite(e.created_at) ? e.created_at : Date.now()
                    }));

                entries = sortEntries(cleaned);
                saveEntries(entries);
                page = Math.max(1, Math.ceil(entries.length / PAGE_SIZE));
                render();
            } catch {
                alert("Import failed. Please choose a valid JSON export from this app.");
            } finally {
                filePick.value = "";
            }
        });

        resetBtn.addEventListener("click", () => {
            if (!confirm("Reset all entries in this browser?")) return;
            entries = [];
            saveEntries(entries);
            page = 1;
            render();
        });

        // First render
        render();
    </script>
</body>

</html>